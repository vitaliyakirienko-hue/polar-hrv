<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polar HRV</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 { color: #667eea; margin-bottom: 20px; }
        .info { background: #e3f2fd; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 13px; }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }
        .status.disconnected { background: #fee; color: #c33; }
        .status.connected { background: #dfe6e9; color: #00b894; }
        .status.streaming { background: #00b894; color: white; }
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
        }
        button.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        button.danger { background: #d63031; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #f5f7fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .metric-label { font-size: 12px; color: #636e72; text-transform: uppercase; }
        .metric-value { font-size: 32px; font-weight: 700; color: #2d3436; }
        .log {
            background: #2d3436;
            color: #dfe6e9;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            margin-top: 20px;
        }
        .log-entry { margin: 2px 0; padding: 2px 0; }
        .log-entry.success { color: #55efc4; }
        .log-entry.error { color: #ff7675; }
        .log-entry.warn { color: #fdcb6e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Polar HRV Monitor</h1>
        
        <div class="info">
            <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
            1. –ó–∞–∫—Ä–æ–π—Ç–µ Polar Beat/Flow/Kubios<br>
            2. <strong>–í–ê–ñ–ù–û:</strong> –û—Ç–∫–ª—é—á–∏—Ç–µ Huawei —á–∞—Å—ã –æ—Ç Bluetooth<br>
            3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –¥–∞—Ç—á–∏–∫ (H10/H9/Verity Sense/OH1)<br>
            4. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–º–µ—Ä - RR –¥–æ–ª–∂–Ω—ã –ø–æ–π—Ç–∏ —Å—Ä–∞–∑—É
        </div>
        
        <div class="info" style="background: #fff3cd; border: 1px solid #ffeaa7;">
            <strong>‚ö†Ô∏è Verity Sense –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</strong><br>
            ‚Ä¢ Verity Sense –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Web Bluetooth<br>
            ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Polar Beat —Å–Ω–∞—á–∞–ª–∞<br>
            ‚Ä¢ –ó–∞—Ç–µ–º –∑–∞–∫—Ä–æ–π—Ç–µ Polar Beat –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞<br>
            ‚Ä¢ –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ H10 –∏–ª–∏ H9
        </div>
        
        <div class="info" style="background: #e8f5e8; border: 1px solid #4caf50;">
            <strong>‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:</strong><br>
            ‚Ä¢ Polar H10 (–≥—Ä—É–¥–Ω–æ–π —Ä–µ–º–µ–Ω—å) - –ª—É—á—à–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å<br>
            ‚Ä¢ Polar H9 (–≥—Ä—É–¥–Ω–æ–π —Ä–µ–º–µ–Ω—å) - —Ö–æ—Ä–æ—à–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å<br>
            ‚Ä¢ Verity Sense - –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å Web Bluetooth
        </div>
        
        <div id="status" class="status disconnected">
            –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
        </div>
        
        <button id="connectBtn" class="primary" onclick="connect()">
            –ü–æ–¥–∫–ª—é—á–∏—Ç—å Polar
        </button>
        
        <button id="startBtn" class="primary" onclick="start()" disabled>
            –ù–∞—á–∞—Ç—å –∑–∞–º–µ—Ä
        </button>
        
        <button id="stopBtn" class="danger" onclick="stop()" style="display:none">
            –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        </button>
        
        <div class="metrics" id="metrics" style="display:none">
            <div class="metric-card">
                <div class="metric-label">–ß–°–°</div>
                <div class="metric-value"><span id="hr">-</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">RR —Ç–æ—á–µ–∫</div>
                <div class="metric-value"><span id="rrCount">0</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">RMSSD</div>
                <div class="metric-value"><span id="rmssd">-</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">SDNN</div>
                <div class="metric-value"><span id="sdnn">-</span></div>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }
        
        let device, hrChar;
        let rrData = [];
        let sessionId, startTime;
        let lastHRTime = 0;
        
        function log(msg, type = 'info') {
            const div = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            div.insertBefore(entry, div.firstChild);
            console.log(msg);
        }
        
        async function connect() {
            try {
                log('–ü–æ–∏—Å–∫ Polar —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
                log('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ: H10, H9, Verity Sense, OH1', 'info');
                log('‚ö†Ô∏è Verity Sense –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏', 'warn');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Web Bluetooth
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                }
                
                log('Web Bluetooth –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–∏—Å–∫–∞
                let deviceFound = false;
                
                // –°–ø–æ—Å–æ–± 1: –ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–≤–∏—Å—É Heart Rate
                try {
                    device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: ['heart_rate'] }],
                        optionalServices: ['heart_rate']
                    });
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ —Å–µ—Ä–≤–∏—Å—É: ${device.name}`, 'success');
                    deviceFound = true;
                } catch (serviceError) {
                    log('–ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–≤–∏—Å—É –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º –ø–æ –∏–º–µ–Ω–∏...', 'warn');
                }
                
                // –°–ø–æ—Å–æ–± 2: –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Å–ø–æ—Å–æ–± –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
                if (!deviceFound) {
                    try {
                        log('–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –∏–º–µ–Ω–∏...', 'info');
                        device = await navigator.bluetooth.requestDevice({
                            filters: [
                                { namePrefix: 'Polar H10' },
                                { namePrefix: 'Polar H9' },
                                { namePrefix: 'Polar Verity' },
                                { namePrefix: 'Polar OH1' },
                                { namePrefix: 'Verity Sense' }
                            ],
                            optionalServices: ['heart_rate']
                        });
                        log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ –∏–º–µ–Ω–∏: ${device.name}`, 'success');
                        deviceFound = true;
                    } catch (nameError) {
                        log(`–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${nameError.message}`, 'warn');
                        log('–ü—Ä–æ–±—É–µ–º –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤...', 'info');
                    }
                }
                
                // –°–ø–æ—Å–æ–± 3: –ü–æ–∏—Å–∫ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
                if (!deviceFound) {
                    try {
                        log('–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)...', 'info');
                        device = await navigator.bluetooth.requestDevice({
                            acceptAllDevices: true,
                            optionalServices: ['heart_rate']
                        });
                        log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${device.name}`, 'success');
                        deviceFound = true;
                    } catch (noFilterError) {
                        log(`–ü–æ–∏—Å–∫ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${noFilterError.message}`, 'error');
                        
                        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è Verity Sense
                        log('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Verity Sense:', 'info');
                        log('1. Verity Sense –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Web Bluetooth', 'warn');
                        log('2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Polar Beat', 'warn');
                        log('3. –ó–∞—Ç–µ–º –∑–∞–∫—Ä–æ–π—Ç–µ Polar Beat –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞', 'warn');
                        log('4. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ H10 –∏–ª–∏ H9', 'warn');
                        
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. Verity Sense –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Web Bluetooth API.');
                    }
                }
                
                if (!deviceFound) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ');
                }
                
                log(`‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–æ: ${device.name}`, 'success');
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('heart_rate');
                hrChar = await service.getCharacteristic('heart_rate_measurement');
                
                log('HR characteristic –ø–æ–ª—É—á–µ–Ω', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞
                const props = hrChar.properties;
                log(`–°–≤–æ–π—Å—Ç–≤–∞: notify=${props.notify}, read=${props.read}`, 'info');
                
                document.getElementById('status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('status').className = 'status connected';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('connectBtn').disabled = true;
                
            } catch (e) {
                log(`–û—à–∏–±–∫–∞: ${e.message}`, 'error');
            }
        }
        
        async function start() {
            sessionId = `s${Date.now()}`;
            startTime = Date.now();
            rrData = [];
            lastHRTime = 0;
            
            document.getElementById('metrics').style.display = 'grid';
            log('–ó–∞–ø—É—Å–∫ –∑–∞–º–µ—Ä–∞...');
            
            try {
                // –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                await hrChar.startNotifications();
                hrChar.addEventListener('characteristicvaluechanged', onData);
                
                log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', 'success');
                log('–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Polar —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...', 'info');
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –¥–ª—è Verity Sense
                if (device.name && device.name.includes('Verity')) {
                    log('üîß –û–±–Ω–∞—Ä—É–∂–µ–Ω Verity Sense - –ø–æ–ø—ã—Ç–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ RR –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤...', 'info');
                    log('‚ö†Ô∏è Verity Sense –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å RR —á–µ—Ä–µ–∑ Web Bluetooth', 'warn');
                    log('üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Polar Beat, –∑–∞—Ç–µ–º –∑–∞–∫—Ä–æ–π—Ç–µ –µ–≥–æ', 'info');
                }
                
                document.getElementById('status').textContent = '–ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö';
                document.getElementById('status').className = 'status streaming';
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (rrData.length === 0) {
                        log('RR –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:', 'warn');
                        log('1. –î–∞—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º', 'warn');
                        log('2. –î–∞—Ç—á–∏–∫ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å (—Å–Ω—è—Ç—å/–Ω–∞–¥–µ—Ç—å)', 'warn');
                        log('3. –ü—Ä–æ—à–∏–≤–∫–∞ H10 —Å—Ç–∞—Ä–∞—è (–æ–±–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ Polar Flow)', 'warn');
                    }
                }, 5000);
                
            } catch (e) {
                log(`–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: ${e.message}`, 'error');
            }
        }
        
        function onData(event) {
            const now = Date.now();
            if (now - lastHRTime < 100) return; // –î–µ–±–∞—É–Ω—Å
            lastHRTime = now;
            
            const v = event.target.value;
            const flags = v.getUint8(0);
            
            // –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å RAW –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–µ 3 —Ä–∞–∑–∞
            if (rrData.length < 3) {
                let hex = '';
                for (let i = 0; i < Math.min(v.byteLength, 20); i++) {
                    hex += v.getUint8(i).toString(16).padStart(2, '0') + ' ';
                }
                log(`RAW: ${hex}`, 'info');
                log(`–§–ª–∞–≥–∏: ${flags.toString(2).padStart(8, '0')} (${flags})`, 'info');
            }
            
            let pos = 1;
            
            // HR –∑–Ω–∞—á–µ–Ω–∏–µ
            const hrIs16bit = flags & 0x01;
            const hr = hrIs16bit ? v.getUint16(pos, true) : v.getUint8(pos);
            pos += hrIs16bit ? 2 : 1;
            
            document.getElementById('hr').textContent = hr;
            
            // Sensor Contact
            const contactStatus = (flags >> 1) & 0x03;
            if (contactStatus !== 3 && rrData.length < 3) {
                log('–ö–æ–Ω—Ç–∞–∫—Ç —Å —Ç–µ–ª–æ–º: ' + (contactStatus === 3 ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'), 'warn');
            }
            
            // Energy Expended
            if (flags & 0x08) {
                pos += 2;
            }
            
            // RR Intervals
            const rrPresent = (flags >> 4) & 0x01;
            
            if (rrPresent) {
                const remaining = v.byteLength - pos;
                const count = Math.floor(remaining / 2);
                
                if (count > 0) {
                    log(`–ü–æ–ª—É—á–µ–Ω–æ ${count} RR –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤!`, 'success');
                }
                
                for (let i = 0; i < count; i++) {
                    const rr = v.getUint16(pos, true);
                    pos += 2;
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: 1/1024 —Å–µ–∫—É–Ω–¥—ã -> –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
                    const rrMs = (rr * 1000) / 1024;
                    
                    if (rrMs >= 300 && rrMs <= 2000) {
                        rrData.push(rrMs);
                        
                        const total = rrData.length;
                        document.getElementById('rrCount').textContent = total;
                        
                        if (total === 1) {
                            log(`–ü–µ—Ä–≤—ã–π RR: ${rrMs.toFixed(0)}ms`, 'success');
                        }
                        
                        if (total >= 10) {
                            calc();
                        }
                    } else {
                        log(`RR –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: ${rrMs.toFixed(0)}ms`, 'warn');
                    }
                }
            } else {
                if (rrData.length === 0) {
                    log('RR —Ñ–ª–∞–≥ = 0 (–¥–∞—Ç—á–∏–∫ –Ω–µ –æ—Ç–¥–∞—ë—Ç RR)', 'warn');
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è Verity Sense
                    if (device.name && device.name.includes('Verity')) {
                        log('üîç Verity Sense –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:', 'info');
                        log('‚Ä¢ Verity Sense –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å RR —á–µ—Ä–µ–∑ Web Bluetooth', 'warn');
                        log('‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Polar Beat', 'warn');
                        log('‚Ä¢ –ó–∞—Ç–µ–º –∑–∞–∫—Ä–æ–π—Ç–µ Polar Beat –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞', 'warn');
                        log('‚Ä¢ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ H10 –∏–ª–∏ H9 –¥–ª—è RR –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤', 'warn');
                    } else {
                        log('üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è RR:', 'info');
                        log('‚Ä¢ –î–∞—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º', 'info');
                        log('‚Ä¢ –î–∞—Ç—á–∏–∫ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å (—Å–Ω—è—Ç—å/–Ω–∞–¥–µ—Ç—å)', 'info');
                        log('‚Ä¢ –ü—Ä–æ—à–∏–≤–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞ (–æ–±–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ Polar Flow)', 'info');
                    }
                }
            }
        }
        
        function calc() {
            const recent = rrData.slice(-30);
            if (recent.length < 10) return;
            
            const mean = recent.reduce((a,b)=>a+b,0) / recent.length;
            
            // RMSSD
            let sumSq = 0;
            for (let i = 1; i < recent.length; i++) {
                const d = recent[i] - recent[i-1];
                sumSq += d*d;
            }
            const rmssd = Math.sqrt(sumSq / (recent.length-1));
            
            // SDNN
            const variance = recent.reduce((a,v) => a + Math.pow(v-mean,2), 0) / recent.length;
            const sdnn = Math.sqrt(variance);
            
            document.getElementById('rmssd').textContent = Math.round(rmssd);
            document.getElementById('sdnn').textContent = Math.round(sdnn);
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç
            if (tg && rrData.length % 50 === 0) {
                tg.sendData(JSON.stringify({
                    sessionId,
                    timestamp: Date.now(),
                    hr: Math.round(60000/mean),
                    rmssd: Math.round(rmssd),
                    sdnn: Math.round(sdnn),
                    rrIntervals: recent
                }));
                log('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç', 'success');
            }
        }
        
        async function stop() {
            if (hrChar) {
                await hrChar.stopNotifications();
                hrChar.removeEventListener('characteristicvaluechanged', onData);
            }
            
            // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
            if (tg && rrData.length > 0) {
                const recent = rrData.slice(-30);
                const mean = recent.reduce((a,b)=>a+b,0) / recent.length;
                
                let sumSq = 0;
                for (let i = 1; i < recent.length; i++) {
                    const d = recent[i] - recent[i-1];
                    sumSq += d*d;
                }
                const rmssd = Math.sqrt(sumSq / (recent.length-1));
                
                const variance = recent.reduce((a,v) => a + Math.pow(v-mean,2), 0) / recent.length;
                const sdnn = Math.sqrt(variance);
                
                tg.sendData(JSON.stringify({
                    sessionId,
                    duration: Date.now() - startTime,
                    totalDataPoints: rrData.length,
                    hr: Math.round(60000/mean),
                    rmssd: Math.round(rmssd),
                    sdnn: Math.round(sdnn),
                    allRRIntervals: rrData,
                    sessionComplete: true
                }));
            }
            
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            document.getElementById('status').className = 'status connected';
            
            log(`–ó–∞–≤–µ—Ä—à–µ–Ω–æ. –í—Å–µ–≥–æ RR: ${rrData.length}`, 'success');
        }
    </script>
</body>
</html>