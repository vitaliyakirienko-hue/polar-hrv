<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polar HRV</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 { color: #667eea; margin-bottom: 20px; }
        .info { background: #e3f2fd; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 13px; }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }
        .status.disconnected { background: #fee; color: #c33; }
        .status.connected { background: #dfe6e9; color: #00b894; }
        .status.streaming { background: #00b894; color: white; }
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
        }
        button.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        button.danger { background: #d63031; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #f5f7fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .metric-label { font-size: 12px; color: #636e72; text-transform: uppercase; }
        .metric-value { font-size: 32px; font-weight: 700; color: #2d3436; }
        .log {
            background: #2d3436;
            color: #dfe6e9;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            margin-top: 20px;
        }
        .log-entry { margin: 2px 0; padding: 2px 0; }
        .log-entry.success { color: #55efc4; }
        .log-entry.error { color: #ff7675; }
        .log-entry.warn { color: #fdcb6e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Polar HRV Monitor</h1>
        
        <div class="info">
            <strong>Инструкция:</strong><br>
            1. Закройте Polar Beat/Flow/Kubios<br>
            2. <strong>ВАЖНО:</strong> Отключите Huawei часы от Bluetooth<br>
            3. Подключите датчик (H10/H9/Verity Sense/OH1)<br>
            4. Начните замер - RR должны пойти сразу
        </div>
        
        <div class="info" style="background: #fff3cd; border: 1px solid #ffeaa7;">
            <strong>⚠️ Verity Sense особенности:</strong><br>
            • Verity Sense может не поддерживать Web Bluetooth<br>
            • Попробуйте активировать через Polar Beat сначала<br>
            • Затем закройте Polar Beat и попробуйте снова<br>
            • Если не работает - используйте H10 или H9
        </div>
        
        <div class="info" style="background: #e8f5e8; border: 1px solid #4caf50;">
            <strong>✅ Альтернативы:</strong><br>
            • Polar H10 (грудной ремень) - лучшая совместимость<br>
            • Polar H9 (грудной ремень) - хорошая совместимость<br>
            • Verity Sense - может не работать с Web Bluetooth
        </div>
        
        <div id="status" class="status disconnected">
            Не подключено
        </div>
        
        <button id="connectBtn" class="primary" onclick="connect()">
            Подключить Polar
        </button>
        
        <button id="startBtn" class="primary" onclick="start()" disabled>
            Начать замер
        </button>
        
        <button id="stopBtn" class="danger" onclick="stop()" style="display:none">
            Остановить
        </button>
        
        <div class="metrics" id="metrics" style="display:none">
            <div class="metric-card">
                <div class="metric-label">ЧСС</div>
                <div class="metric-value"><span id="hr">-</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">RR точек</div>
                <div class="metric-value"><span id="rrCount">0</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">RMSSD</div>
                <div class="metric-value"><span id="rmssd">-</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">SDNN</div>
                <div class="metric-value"><span id="sdnn">-</span></div>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }
        
        let device, hrChar;
        let rrData = [];
        let sessionId, startTime;
        let lastHRTime = 0;
        
        function log(msg, type = 'info') {
            const div = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            div.insertBefore(entry, div.firstChild);
            console.log(msg);
        }
        
        async function connect() {
            try {
                log('Поиск Polar устройств...');
                log('Поддерживаемые: H10, H9, Verity Sense, OH1', 'info');
                log('⚠️ Verity Sense может требовать специальной активации', 'warn');
                
                // Проверяем поддержку Web Bluetooth
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth не поддерживается в этом браузере');
                }
                
                log('Web Bluetooth поддерживается', 'success');
                
                // Попробуем разные способы поиска
                let deviceFound = false;
                
                // Способ 1: Поиск по сервису Heart Rate
                try {
                    device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: ['heart_rate'] }],
                        optionalServices: ['heart_rate']
                    });
                    log(`✅ Найдено по сервису: ${device.name}`, 'success');
                    deviceFound = true;
                } catch (serviceError) {
                    log('Поиск по сервису не дал результатов, пробуем по имени...', 'warn');
                }
                
                // Способ 2: Поиск по имени (если первый способ не сработал)
                if (!deviceFound) {
                    try {
                        log('Попытка поиска по имени...', 'info');
                        device = await navigator.bluetooth.requestDevice({
                            filters: [
                                { namePrefix: 'Polar H10' },
                                { namePrefix: 'Polar H9' },
                                { namePrefix: 'Polar Verity' },
                                { namePrefix: 'Polar OH1' },
                                { namePrefix: 'Verity Sense' }
                            ],
                            optionalServices: ['heart_rate']
                        });
                        log(`✅ Найдено по имени: ${device.name}`, 'success');
                        deviceFound = true;
                    } catch (nameError) {
                        log(`Поиск по имени не дал результатов: ${nameError.message}`, 'warn');
                        log('Пробуем без фильтров...', 'info');
                    }
                }
                
                // Способ 3: Поиск без фильтров (покажет все устройства)
                if (!deviceFound) {
                    try {
                        log('Попытка поиска без фильтров (покажет все устройства)...', 'info');
                        device = await navigator.bluetooth.requestDevice({
                            acceptAllDevices: true,
                            optionalServices: ['heart_rate']
                        });
                        log(`✅ Найдено без фильтров: ${device.name}`, 'success');
                        deviceFound = true;
                    } catch (noFilterError) {
                        log(`Поиск без фильтров не дал результатов: ${noFilterError.message}`, 'error');
                        
                        // Специальная диагностика для Verity Sense
                        log('🔍 Диагностика Verity Sense:', 'info');
                        log('1. Verity Sense может не поддерживать Web Bluetooth', 'warn');
                        log('2. Попробуйте активировать через Polar Beat', 'warn');
                        log('3. Затем закройте Polar Beat и попробуйте снова', 'warn');
                        log('4. Если не работает - используйте H10 или H9', 'warn');
                        
                        throw new Error('Не удалось найти ни одного Bluetooth устройства. Verity Sense может не поддерживать Web Bluetooth API.');
                    }
                }
                
                if (!deviceFound) {
                    throw new Error('Не удалось найти устройство');
                }
                
                log(`✅ Устройство найдено: ${device.name}`, 'success');
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('heart_rate');
                hrChar = await service.getCharacteristic('heart_rate_measurement');
                
                log('HR characteristic получен', 'success');
                
                // Проверить свойства
                const props = hrChar.properties;
                log(`Свойства: notify=${props.notify}, read=${props.read}`, 'info');
                
                document.getElementById('status').textContent = 'Подключено';
                document.getElementById('status').className = 'status connected';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('connectBtn').disabled = true;
                
            } catch (e) {
                log(`Ошибка: ${e.message}`, 'error');
            }
        }
        
        async function start() {
            sessionId = `s${Date.now()}`;
            startTime = Date.now();
            rrData = [];
            lastHRTime = 0;
            
            document.getElementById('metrics').style.display = 'grid';
            log('Запуск замера...');
            
            try {
                // Включить уведомления
                await hrChar.startNotifications();
                hrChar.addEventListener('characteristicvaluechanged', onData);
                
                log('Уведомления включены', 'success');
                log('Ожидание данных от Polar устройства...', 'info');
                
                // Специальная активация для Verity Sense
                if (device.name && device.name.includes('Verity')) {
                    log('🔧 Обнаружен Verity Sense - попытка активации RR интервалов...', 'info');
                    log('⚠️ Verity Sense может не поддерживать RR через Web Bluetooth', 'warn');
                    log('💡 Попробуйте активировать через Polar Beat, затем закройте его', 'info');
                }
                
                document.getElementById('status').textContent = 'Запись данных';
                document.getElementById('status').className = 'status streaming';
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                
                // Проверка через 5 секунд
                setTimeout(() => {
                    if (rrData.length === 0) {
                        log('RR не получены. Возможные причины:', 'warn');
                        log('1. Датчик используется другим приложением', 'warn');
                        log('2. Датчик нужно перезапустить (снять/надеть)', 'warn');
                        log('3. Прошивка H10 старая (обновите через Polar Flow)', 'warn');
                    }
                }, 5000);
                
            } catch (e) {
                log(`Ошибка старта: ${e.message}`, 'error');
            }
        }
        
        function onData(event) {
            const now = Date.now();
            if (now - lastHRTime < 100) return; // Дебаунс
            lastHRTime = now;
            
            const v = event.target.value;
            const flags = v.getUint8(0);
            
            // Логировать RAW данные первые 3 раза
            if (rrData.length < 3) {
                let hex = '';
                for (let i = 0; i < Math.min(v.byteLength, 20); i++) {
                    hex += v.getUint8(i).toString(16).padStart(2, '0') + ' ';
                }
                log(`RAW: ${hex}`, 'info');
                log(`Флаги: ${flags.toString(2).padStart(8, '0')} (${flags})`, 'info');
            }
            
            let pos = 1;
            
            // HR значение
            const hrIs16bit = flags & 0x01;
            const hr = hrIs16bit ? v.getUint16(pos, true) : v.getUint8(pos);
            pos += hrIs16bit ? 2 : 1;
            
            document.getElementById('hr').textContent = hr;
            
            // Sensor Contact
            const contactStatus = (flags >> 1) & 0x03;
            if (contactStatus !== 3 && rrData.length < 3) {
                log('Контакт с телом: ' + (contactStatus === 3 ? 'есть' : 'нет'), 'warn');
            }
            
            // Energy Expended
            if (flags & 0x08) {
                pos += 2;
            }
            
            // RR Intervals
            const rrPresent = (flags >> 4) & 0x01;
            
            if (rrPresent) {
                const remaining = v.byteLength - pos;
                const count = Math.floor(remaining / 2);
                
                if (count > 0) {
                    log(`Получено ${count} RR интервалов!`, 'success');
                }
                
                for (let i = 0; i < count; i++) {
                    const rr = v.getUint16(pos, true);
                    pos += 2;
                    
                    // Конвертация: 1/1024 секунды -> миллисекунды
                    const rrMs = (rr * 1000) / 1024;
                    
                    if (rrMs >= 300 && rrMs <= 2000) {
                        rrData.push(rrMs);
                        
                        const total = rrData.length;
                        document.getElementById('rrCount').textContent = total;
                        
                        if (total === 1) {
                            log(`Первый RR: ${rrMs.toFixed(0)}ms`, 'success');
                        }
                        
                        if (total >= 10) {
                            calc();
                        }
                    } else {
                        log(`RR вне диапазона: ${rrMs.toFixed(0)}ms`, 'warn');
                    }
                }
            } else {
                if (rrData.length === 0) {
                    log('RR флаг = 0 (датчик не отдаёт RR)', 'warn');
                    
                    // Специальная диагностика для Verity Sense
                    if (device.name && device.name.includes('Verity')) {
                        log('🔍 Verity Sense диагностика:', 'info');
                        log('• Verity Sense может не поддерживать RR через Web Bluetooth', 'warn');
                        log('• Попробуйте активировать через Polar Beat', 'warn');
                        log('• Затем закройте Polar Beat и попробуйте снова', 'warn');
                        log('• Альтернатива: используйте H10 или H9 для RR интервалов', 'warn');
                    } else {
                        log('💡 Возможные причины отсутствия RR:', 'info');
                        log('• Датчик используется другим приложением', 'info');
                        log('• Датчик нужно перезапустить (снять/надеть)', 'info');
                        log('• Прошивка устарела (обновите через Polar Flow)', 'info');
                    }
                }
            }
        }
        
        function calc() {
            const recent = rrData.slice(-30);
            if (recent.length < 10) return;
            
            const mean = recent.reduce((a,b)=>a+b,0) / recent.length;
            
            // RMSSD
            let sumSq = 0;
            for (let i = 1; i < recent.length; i++) {
                const d = recent[i] - recent[i-1];
                sumSq += d*d;
            }
            const rmssd = Math.sqrt(sumSq / (recent.length-1));
            
            // SDNN
            const variance = recent.reduce((a,v) => a + Math.pow(v-mean,2), 0) / recent.length;
            const sdnn = Math.sqrt(variance);
            
            document.getElementById('rmssd').textContent = Math.round(rmssd);
            document.getElementById('sdnn').textContent = Math.round(sdnn);
            
            // Отправка в бот
            if (tg && rrData.length % 50 === 0) {
                tg.sendData(JSON.stringify({
                    sessionId,
                    timestamp: Date.now(),
                    hr: Math.round(60000/mean),
                    rmssd: Math.round(rmssd),
                    sdnn: Math.round(sdnn),
                    rrIntervals: recent
                }));
                log('Данные отправлены в бот', 'success');
            }
        }
        
        async function stop() {
            if (hrChar) {
                await hrChar.stopNotifications();
                hrChar.removeEventListener('characteristicvaluechanged', onData);
            }
            
            // Финальная отправка
            if (tg && rrData.length > 0) {
                const recent = rrData.slice(-30);
                const mean = recent.reduce((a,b)=>a+b,0) / recent.length;
                
                let sumSq = 0;
                for (let i = 1; i < recent.length; i++) {
                    const d = recent[i] - recent[i-1];
                    sumSq += d*d;
                }
                const rmssd = Math.sqrt(sumSq / (recent.length-1));
                
                const variance = recent.reduce((a,v) => a + Math.pow(v-mean,2), 0) / recent.length;
                const sdnn = Math.sqrt(variance);
                
                tg.sendData(JSON.stringify({
                    sessionId,
                    duration: Date.now() - startTime,
                    totalDataPoints: rrData.length,
                    hr: Math.round(60000/mean),
                    rmssd: Math.round(rmssd),
                    sdnn: Math.round(sdnn),
                    allRRIntervals: rrData,
                    sessionComplete: true
                }));
            }
            
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('status').textContent = 'Подключено';
            document.getElementById('status').className = 'status connected';
            
            log(`Завершено. Всего RR: ${rrData.length}`, 'success');
        }
    </script>
</body>
</html>