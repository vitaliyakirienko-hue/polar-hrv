<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polar HRV</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 { color: #667eea; margin-bottom: 20px; }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }
        .status.disconnected { background: #fee; color: #c33; }
        .status.connected { background: #dfe6e9; color: #00b894; }
        .status.streaming { background: #00b894; color: white; }
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
        }
        button.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        button.danger { background: #d63031; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #f5f7fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .metric-label { font-size: 12px; color: #636e72; text-transform: uppercase; }
        .metric-value { font-size: 32px; font-weight: 700; color: #2d3436; }
        .log {
            background: #2d3436;
            color: #dfe6e9;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            margin-top: 20px;
        }
        .log-entry { margin: 2px 0; padding: 2px 0; }
        .log-entry.success { color: #55efc4; }
        .log-entry.error { color: #ff7675; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Polar HRV Monitor</h1>
        
        <div id="status" class="status disconnected">
            Устройство не подключено
        </div>
        
        <button id="connectBtn" class="primary" onclick="connect()">
            Подключить Polar H10
        </button>
        
        <button id="startBtn" class="primary" onclick="startStream()" disabled>
            Начать стрим RR/HR
        </button>
        
        <button id="stopBtn" class="danger" onclick="stopStream()" style="display:none">
            Остановить
        </button>
        
        <div class="metrics" id="metrics" style="display:none">
            <div class="metric-card">
                <div class="metric-label">ЧСС</div>
                <div class="metric-value"><span id="hr">-</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">RR точек</div>
                <div class="metric-value"><span id="rrCount">0</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">RMSSD</div>
                <div class="metric-value"><span id="rmssd">-</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">SDNN</div>
                <div class="metric-value"><span id="sdnn">-</span></div>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }
        
        // Polar H10 UUIDs
        const HR_SERVICE = '0000180d-0000-1000-8000-00805f9b34fb';
        const HR_MEASUREMENT = '00002a37-0000-1000-8000-00805f9b34fb';
        const PMD_SERVICE = 'fb005c80-02e7-f387-1cad-8acd2d8df0c8';
        const PMD_CONTROL = 'fb005c81-02e7-f387-1cad-8acd2d8df0c8';
        const PMD_DATA = 'fb005c82-02e7-f387-1cad-8acd2d8df0c8';
        
        let device, server;
        let hrChar, pmdCtrl, pmdData;
        let rrData = [];
        let sessionId, startTime;
        let streamingRR = false;
        
        function log(msg, type = 'info') {
            const div = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            div.insertBefore(entry, div.firstChild);
            console.log(msg);
        }
        
        async function connect() {
            try {
                log('Поиск Polar устройства...');
                
                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: [HR_SERVICE] }
                    ],
                    optionalServices: [HR_SERVICE, PMD_SERVICE]
                });
                
                log(`Найдено: ${device.name}`, 'success');
                
                server = await device.gatt.connect();
                log('GATT подключен', 'success');
                
                // HR Service
                const hrService = await server.getPrimaryService(HR_SERVICE);
                hrChar = await hrService.getCharacteristic(HR_MEASUREMENT);
                log('HR сервис готов', 'success');
                
                // PMD Service
                try {
                    const pmdService = await server.getPrimaryService(PMD_SERVICE);
                    pmdCtrl = await pmdService.getCharacteristic(PMD_CONTROL);
                    pmdData = await pmdService.getCharacteristic(PMD_DATA);
                    log('PMD сервис готов (RR стрим доступен)', 'success');
                } catch (e) {
                    log('PMD недоступен, будет базовый HR', 'error');
                }
                
                document.getElementById('status').textContent = 'Подключено к ' + device.name;
                document.getElementById('status').className = 'status connected';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('connectBtn').disabled = true;
                
            } catch (e) {
                log(`Ошибка: ${e.message}`, 'error');
            }
        }
        
        async function startStream() {
            sessionId = `s${Date.now()}`;
            startTime = Date.now();
            rrData = [];
            
            document.getElementById('metrics').style.display = 'grid';
            log('Запуск стрима...');
            
            // Метод 1: PMD стрим (самый надёжный для RR)
            if (pmdCtrl && pmdData) {
                try {
                    log('Активация PMD HR стрима...');
                    
                    // Команда: Start HR measurement stream
                    // Format: [0x02 (REQUEST), 0x00 (HR type), settings...]
                    const startCmd = new Uint8Array([
                        0x02,  // REQUEST_START
                        0x00,  // HR measurement type
                        0x00, 0x01, // Settings length
                        0x82, 0x00, // Sample rate (130 Hz)
                        0x01, 0x01, // Resolution
                        0x0E, 0x00  // Range
                    ]);
                    
                    await pmdCtrl.writeValue(startCmd);
                    log('PMD команда отправлена', 'success');
                    
                    // Подписка на PMD data
                    await pmdData.startNotifications();
                    pmdData.addEventListener('characteristicvaluechanged', onPMDData);
                    log('PMD стрим активирован', 'success');
                    
                    streamingRR = true;
                    
                } catch (e) {
                    log(`PMD ошибка: ${e.message}`, 'error');
                    log('Переключение на HR характеристику...');
                    streamingRR = false;
                }
            }
            
            // Метод 2: Стандартный HR (всегда включаем как запасной)
            await hrChar.startNotifications();
            hrChar.addEventListener('characteristicvaluechanged', onHRData);
            log('HR уведомления активны', 'success');
            
            document.getElementById('status').textContent = streamingRR ? 'PMD стрим активен' : 'HR мониторинг';
            document.getElementById('status').className = 'status streaming';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
        }
        
        function onPMDData(event) {
            // PMD формат более сложный, содержит ECG/RR данные
            const value = event.target.value;
            const type = value.getUint8(0);
            
            log(`PMD пакет получен (тип: ${type})`, 'success');
            
            // Type 0x00 = HR data with RR
            if (type === 0x00) {
                // Пропускаем header (9 байт) и читаем HR samples
                let offset = 10;
                
                while (offset + 3 < value.byteLength) {
                    const hr = value.getUint8(offset);
                    const rrPresent = value.getUint8(offset + 1);
                    
                    if (rrPresent > 0) {
                        const rr = value.getUint16(offset + 2, true);
                        const rrMs = Math.round((rr / 1024) * 1000);
                        
                        if (rrMs > 300 && rrMs < 2000) {
                            rrData.push(rrMs);
                            document.getElementById('rrCount').textContent = rrData.length;
                            document.getElementById('hr').textContent = hr;
                            
                            if (rrData.length >= 10) calc();
                            
                            log(`RR: ${rrMs}ms, HR: ${hr}`, 'success');
                        }
                    }
                    
                    offset += 4;
                }
            }
        }
        
        function onHRData(event) {
            const v = event.target.value;
            const flags = v.getUint8(0);
            
            let pos = 1;
            const hr = (flags & 1) ? v.getUint16(pos, true) : v.getUint8(pos);
            pos += (flags & 1) ? 2 : 1;
            
            document.getElementById('hr').textContent = hr;
            
            if (flags & 0x08) pos += 2; // Skip Energy Expended
            
            // RR intervals
            if (flags & 0x10) {
                const remaining = v.byteLength - pos;
                const count = Math.floor(remaining / 2);
                
                if (count > 0) {
                    log(`HR: ${count} RR интервалов получено`, 'success');
                }
                
                for (let i = 0; i < count; i++) {
                    const rr = v.getUint16(pos, true);
                    pos += 2;
                    const ms = Math.round((rr / 1024) * 1000);
                    
                    if (ms > 300 && ms < 2000) {
                        rrData.push(ms);
                        document.getElementById('rrCount').textContent = rrData.length;
                        
                        if (rrData.length >= 10) calc();
                    }
                }
            }
        }
        
        function calc() {
            const recent = rrData.slice(-30);
            const mean = recent.reduce((a,b)=>a+b,0) / recent.length;
            
            let sumSq = 0;
            for (let i = 1; i < recent.length; i++) {
                const d = recent[i] - recent[i-1];
                sumSq += d*d;
            }
            const rmssd = Math.sqrt(sumSq / (recent.length-1));
            
            const variance = recent.reduce((a,v) => a + Math.pow(v-mean,2), 0) / recent.length;
            const sdnn = Math.sqrt(variance);
            
            document.getElementById('rmssd').textContent = Math.round(rmssd);
            document.getElementById('sdnn').textContent = Math.round(sdnn);
            
            if (tg && rrData.length % 50 === 0) {
                tg.sendData(JSON.stringify({
                    sessionId,
                    timestamp: Date.now(),
                    hr: Math.round(60000/mean),
                    rmssd: Math.round(rmssd),
                    sdnn: Math.round(sdnn),
                    rrIntervals: recent
                }));
            }
        }
        
        async function stopStream() {
            if (pmdCtrl && streamingRR) {
                try {
                    // Stop PMD stream
                    const stopCmd = new Uint8Array([0x03, 0x00]);
                    await pmdCtrl.writeValue(stopCmd);
                    log('PMD стрим остановлен');
                } catch (e) {
                    log(`PMD stop ошибка: ${e.message}`, 'error');
                }
            }
            
            if (pmdData) {
                try {
                    await pmdData.stopNotifications();
                    pmdData.removeEventListener('characteristicvaluechanged', onPMDData);
                } catch (e) {}
            }
            
            if (hrChar) {
                await hrChar.stopNotifications();
                hrChar.removeEventListener('characteristicvaluechanged', onHRData);
            }
            
            if (tg && rrData.length > 0) {
                const recent = rrData.slice(-30);
                const mean = recent.reduce((a,b)=>a+b,0) / recent.length;
                let sumSq = 0;
                for (let i = 1; i < recent.length; i++) {
                    const d = recent[i] - recent[i-1];
                    sumSq += d*d;
                }
                const rmssd = Math.sqrt(sumSq / (recent.length-1));
                const variance = recent.reduce((a,v) => a + Math.pow(v-mean,2), 0) / recent.length;
                const sdnn = Math.sqrt(variance);
                
                tg.sendData(JSON.stringify({
                    sessionId,
                    duration: Date.now() - startTime,
                    totalDataPoints: rrData.length,
                    hr: Math.round(60000/mean),
                    rmssd: Math.round(rmssd),
                    sdnn: Math.round(sdnn),
                    allRRIntervals: rrData,
                    sessionComplete: true
                }));
            }
            
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('status').textContent = 'Подключено';
            document.getElementById('status').className = 'status connected';
            
            log(`Сессия завершена. RR точек: ${rrData.length}`, 'success');
        }
    </script>
</body>
</html>